<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Wallpaper Ayat Harian</title>
<style>
	@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap');

	body {
		font-family: 'Cormorant Garamond', serif;
	}
	.bg-black {
        --bs-bg-opacity: 1;
        background-color: rgb(0 0 0 / 63%) !important;
	}
    body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        font-family: 'Segoe UI', sans-serif;
        color: white!important;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    #bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        z-index: -2;
    }

    #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.45); /* transparency */
        z-index: 5;
    }

    #container {
        width: 70%;
        max-width: 900px;
		text-align: center;    
		z-index: 10;
    	font-family: cursive;
    }

    #ref {
        font-size: 32px;
        margin-bottom: 15px;
        font-weight: bold;
        text-shadow: 0 0 10px black;
    }

    #text {
        font-size: 24px;
        line-height: 1.45;
        text-shadow: 0 0 10px black;
    }

    .btn-light {
		
		z-index: 10;
        position:relative; bottom:20px; padding:10px 18px; background:#f8f9fa75!important; border:none; border-radius:6px; cursor:pointer;
    }
	 
	.hidden {
    display: none !important;
    } 
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

<div id="bg"></div>
<div id="overlay"></div>

<div id="container">
    <div id="ref">Loading...</div>
    <div id="text"></div>
</div>
 
<div class="container-fluid position-absolute bottom-0 pb-3">
  <div class="row g-2 justify-content-center">
    <div class="col-sm-3">
        <button id="btnDownload" class="btn btn-light w-100">Save Wallpaper</button>
    </div>
    <div class="col-sm-3">
        <button id="btnExport" class="btn btn-light w-100">Export CSV</button>
    </div> 
    <div class="col-sm-3">
        <button id="btnList" class="btn btn-light w-100" data-bs-toggle="modal" data-bs-target="#listVerseModal" onclick="renderVerseList()">List Ayat</button>
    </div>
    <div class="col-sm-3">
        <button id="btnList" class="btn btn-light w-100" data-bs-toggle="modal" data-bs-target="#bgModal" onclick="renderBackgroundList()">Backgrounds</button>
    </div>
 
  </div>
</div>
 

<div class="modal fade" id="addVerseModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-black " >

      <div class="modal-header">
        <h5 class="modal-title">Tambah Ayat ke LocalStorage</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="mb-3">
            <label class="form-label">Reference (contoh: Mazmur 23:1)</label>
            <input type="text" id="mRef" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Ayat</label>
            <textarea id="mVerse" class="form-control" rows="3"></textarea>
        </div>

        <div class="row">
            <div class="col">
                <label class="form-label">Versi</label>
                <input type="text" id="mVersion" class="form-control" placeholder="TB / BIMK / dll">
            </div>
            <div class="col">
                <label class="form-label">Kategori</label>
                <input type="text" id="mCategory" class="form-control">
            </div>
        </div>

        <div class="mt-3">
            <label class="form-label">Catatan</label>
            <input type="text" id="mNotes" class="form-control">
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button id="btnSaveVerse" type="button" class="btn btn-primary">Simpan Ayat</button>
      </div>

    </div>
  </div>
</div>

<!-- Modal: List Verses -->
<div class="modal fade" id="listVerseModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content bg-black">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Daftar Ayat Tersimpan</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-striped table-bordered table-hover" id="tableVerses">
            <thead class="table-dark">
                <tr>
                <th style="width: 5%">No</th>
                <th style="width: 15%">Reference</th>
                <th style="width: 35%">Ayat</th>
                <th style="width: 10%">Versi</th>
                <th style="width: 15%">Kategori</th>
                <th style="width: 15%">Catatan</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        
        <button class="btn btn-success"data-bs-toggle="modal" data-bs-target="#addVerseModal"  id="btnShowAddModal">Add Verse</button>
        <button class="btn btn-warning" data-bs-dismiss="modal" onclick="clearLocalStorage()">Clear LocalStorage</button>
        <button class="btn btn-primary" data-bs-dismiss="modal" onclick="importFallbackIfEmpty()">Import LocalStorage</button>
      </div>

    </div>
  </div>
</div>



<div class="modal fade" id="bgModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-black">

      <div class="modal-header">
        <h5 class="modal-title">Daftar Background Wallpaper</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-bordered table-hover" id="tableBackgrounds">
          <thead class="table-dark">
            <tr>
              <th width="10%">ID</th>
              <th width="40%">Preview</th>
              <th width="20%">Status</th>
              <th width="20%">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>
</div>


<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- Bootstrap 5 JS + Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> 
<script src="script.js"></script>
</body>
<script>
// ===============================
// RANDOM FREE BACKGROUND IMAGES
// =============================== 
const BG_KEY = "backgroundList";
const dummyBackgrounds = [
  "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee",
  "https://images.unsplash.com/photo-1499084732479-de2c02d45fc4",
  "https://images.unsplash.com/photo-1501785888041-af3ef285b470",
  "https://images.unsplash.com/photo-1500534623283-312aade485b7",
  "https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d",
  "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429",
  "https://images.unsplash.com/photo-1499346030926-9a72daac6c63",
  "https://images.unsplash.com/photo-1491553895911-0055eca6402d",
  "https://images.unsplash.com/photo-1470770841072-f978cf4d019e",
  "https://images.unsplash.com/photo-1472214103451-9374bd1c798e",
  "https://images.unsplash.com/photo-1441974231531-c6227db76b6e",
  "https://images.unsplash.com/photo-1469474968028-56623f02e42e",
  "https://images.unsplash.com/photo-1502082553048-f009c37129b9",
  "https://images.unsplash.com/photo-1499088513455-78ed2a3f7f86",
  "https://images.unsplash.com/photo-1470770841072-f978cf4d019e",
  "https://images.unsplash.com/photo-1500534623283-312aade485b7",
  "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429",
  "https://images.unsplash.com/photo-1482192596544-9eb780fc7f66",
  "https://images.unsplash.com/photo-1500534314211-b98d27c0e47c",
  "https://images.unsplash.com/photo-1502082553048-f009c37129b9",
  "https://images.unsplash.com/photo-1503264116251-35a269479413",
  "https://images.unsplash.com/photo-1502082553048-f009c37129b9",
  "https://images.unsplash.com/photo-1506744038136-46273834b3fb",
  "https://images.unsplash.com/photo-1469474968028-56623f02e42e",
  "https://images.unsplash.com/photo-1500375592092-40eb2168fd21",
  "https://images.unsplash.com/photo-1439396087961-98bc12c21176",
  "https://images.unsplash.com/photo-1470770841072-f978cf4d019e",
  "https://images.unsplash.com/photo-1519681393784-d120267933ba",
  "https://images.unsplash.com/photo-1521295121783-8a321d551ad2",
  "https://images.unsplash.com/photo-1500534623283-312aade485b7",
  "https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d",
  "https://images.unsplash.com/photo-1500534314209-a25ddb2bd429",
  "https://images.unsplash.com/photo-1482192596544-9eb780fc7f66",
  "https://images.unsplash.com/photo-1500534314211-b98d27c0e47c",
  "https://images.unsplash.com/photo-1503264116251-35a269479413",
  "https://images.unsplash.com/photo-1502082553048-f009c37129b9",
  "https://images.unsplash.com/photo-1506744038136-46273834b3fb",
  "https://images.unsplash.com/photo-1469474968028-56623f02e42e",
  "https://images.unsplash.com/photo-1500375592092-40eb2168fd21",
  "https://images.unsplash.com/photo-1439396087961-98bc12c21176",
  "https://images.unsplash.com/photo-1519681393784-d120267933ba",
  "https://images.unsplash.com/photo-1521295121783-8a321d551ad2",
  "https://images.unsplash.com/photo-1441974231531-c6227db76b6e",
  "https://images.unsplash.com/photo-1484950763426-56b5bf172dbb",
  "https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5",
  "https://images.unsplash.com/photo-1536305030015-0c2a5e0c0642",
  "https://images.unsplash.com/photo-1505483531331-fc3cf89fd382",
  "https://images.unsplash.com/photo-1518837695005-2083093ee35b",
  "https://images.unsplash.com/photo-1500534623283-312aade485b7"
];

let bgCache = null;


function preloadBackground() {
    const list = loadBGList(); 
    if (list.length === 0) return;

    const random = list[Math.floor(Math.random() * list.length)];
    const url = `${random.url}?w=1200&auto=format&fit=crop&q=60`;

    const img = new Image();
    img.src = url;
    img.onload = () => {
        bgCache = url;
        console.log("Background preloaded");
    };
}

$("#bgModal").on("show.bs.modal", function () {
    if (bgCache) {
        $("#previewBG").css("background-image", `url('${bgCache}')`);
    }
});
function loadBGList() {
    return JSON.parse(localStorage.getItem(BG_KEY) || "[]");
}
function saveBGList(list) {
    localStorage.setItem(BG_KEY, JSON.stringify(list));
}

async function removeBrokenBackgrounds() {
    let list = loadBGList(); // ambil dari localStorage
    let validList = [];

    const checkImage = (url) => {
        return new Promise(resolve => {
            const img = new Image();
            img.onload = () => resolve(true);  // valid
            img.onerror = () => resolve(false); // 404 / broken
            img.src = url;
        });
    };

    for (const item of list) {
        const ok = await checkImage(item.url);

        if (ok) {
            validList.push(item);
        } else {
            console.warn("REMOVED BROKEN IMAGE:", item.url);
        }
    }

    saveBGList(validList);

    console.log(
        `Background cleanup done. Valid: ${validList.length}, Removed: ${
            list.length - validList.length
        }`
    );
}


function importDummyBackgroundsIfEmpty() {
    const existing = loadBGList();

    // kalau sudah ada data, tidak perlu import dummy
    if (existing.length > 0) {
        console.log("Background list already exists, skipping dummy import.");
        return;
    }

    // clean + unique
    const unique = new Set();

    const cleaned = dummyBackgrounds
        .map(url => url.trim().split("?")[0]) // hapus query parameters
        .filter(url => {
            if (unique.has(url)) return false;
            unique.add(url);
            return true;
        });

    // Simpan ke localStorage
    const converted = cleaned.map(url => ({
        id: Date.now() + Math.random(),
        url,
        addedAt: new Date().toISOString()
    }));

    saveBGList(converted);
}

async function renderBackgroundList() {
    const list = JSON.parse(localStorage.getItem(BG_KEY)) || [];
    const tbody = $("#tableBackgrounds tbody");
    tbody.empty();

    if (list.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="4" class="text-center text-muted">Belum ada background.</td>
            </tr>
        `);
        return;
    }

    for (const item of list) {
        const isValid = await checkImage(item.url);

        tbody.append(`
            <tr>
                <td>${item.id}</td>
                <td>
                    <img src="${item.url}" 
                         style="width:80px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #ccc;">
                </td>
                <td>
                    ${isValid ? 
                        '<span class="badge bg-success">OK</span>' : 
                        '<span class="badge bg-danger">BROKEN</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteBackground(${item.id})">
                        Hapus
                    </button>
                </td>
            </tr>
        `);
    }
}
function checkImage(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url + "?w=400&q=40&cache=" + Math.random();
    });
}

function deleteBackground(id) {
    let list = JSON.parse(localStorage.getItem(BG_KEY)) || [];

    list = list.filter(item => item.id !== id);

    localStorage.setItem(BG_KEY, JSON.stringify(list));

    renderBackgroundList();
}

document.addEventListener("DOMContentLoaded", function () {
    importDummyBackgroundsIfEmpty();
    removeBrokenBackgrounds();
    setRandomBackground();
});


function setRandomBackground() {
    const list = JSON.parse(localStorage.getItem(BG_KEY)) || [];

    if (list.length === 0) {
        console.warn("Background list kosong!");
        return;
    }

    const random = list[Math.floor(Math.random() * list.length)];

    $("#bg").css("background-image", `url('${random.url}?w=1920')`);
}

const STORAGE_KEY = "verseHistory";
// ===============================
// SAMPLE 5 AYAT FALLBACK LOCAL
// ===============================
const fallbackVerses = [
    {
        id: 1,
        reference: "Mazmur 23:1",
        verse: "TUHAN adalah gembalaku, takkan kekurangan aku.",
        version: "TB",
        category: "penguatan",
        notes: ""
    },
    {
        id: 2,
        reference: "Yesaya 41:10",
        verse: "Janganlah takut, sebab Aku menyertai engkau; janganlah bimbang, sebab Aku ini Allahmu.",
        version: "TB",
        category: "penguatan",
        notes: ""
    },
    {
        id: 3,
        reference: "Yeremia 29:11",
        verse: "Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu...",
        version: "TB",
        category: "pengharapan",
        notes: ""
    },
    {
        id: 4,
        reference: "Filipi 4:13",
        verse: "Segala perkara dapat kutanggung di dalam Dia yang memberi kekuatan kepadaku.",
        version: "TB",
        category: "penguatan",
        notes: ""
    },
    {
        id: 5,
        reference: "Roma 8:28",
        verse: "Allah turut bekerja dalam segala sesuatu untuk mendatangkan kebaikan bagi mereka yang mengasihi Dia.",
        version: "TB",
        category: "pengharapan",
        notes: ""
    },
    {
        id: 6,
        reference: "Mazmur 91:1",
        verse: "Orang yang duduk dalam lindungan Yang Mahatinggi dan bermalam dalam naungan Yang Mahakuasa...",
        version: "TB",
        category: "penghiburan",
        notes: ""
    },
    {
        id: 7,
        reference: "Amsal 3:5‚Äì6",
        verse: "Percayalah kepada TUHAN dengan segenap hatimu, dan janganlah bersandar kepada pengertianmu sendiri.",
        version: "TB",
        category: "hikmat",
        notes: ""
    },
    {
        id: 8,
        reference: "Mazmur 46:1",
        verse: "Allah itu bagi kita tempat perlindungan dan kekuatan, sebagai penolong dalam kesesakan sangat terbukti.",
        version: "TB",
        category: "penghiburan",
        notes: ""
    },
    {
        id: 9,
        reference: "Matius 11:28",
        verse: "Marilah kepada-Ku, semua yang letih lesu dan berbeban berat, Aku akan memberi kelegaan kepadamu.",
        version: "TB",
        category: "penghiburan",
        notes: ""
    },
    {
        id: 10,
        reference: "Mazmur 121:1‚Äì2",
        verse: "Aku melayangkan mataku ke gunung-gunung; dari manakah akan datang pertolonganku?",
        version: "TB",
        category: "pengharapan",
        notes: ""
    },
    {
        id: 11,
        reference: "1 Korintus 13:4",
        verse: "Kasih itu sabar; kasih itu murah hati; ia tidak cemburu.",
        version: "TB",
        category: "kasih",
        notes: ""
    },
    {
        id: 12,
        reference: "Mazmur 34:18",
        verse: "TUHAN itu dekat kepada orang yang patah hati, dan Ia menyelamatkan orang-orang yang remuk jiwanya.",
        version: "TB",
        category: "penghiburan",
        notes: ""
    },
    {
        id: 13,
        reference: "Yesaya 40:31",
        verse: "Tetapi orang-orang yang menanti-nantikan TUHAN mendapat kekuatan baru...",
        version: "TB",
        category: "pengharapan",
        notes: ""
    },
    {
        id: 14,
        reference: "Yohanes 14:27",
        verse: "Damai sejahtera Kutinggalkan bagimu. Damai sejahtera-Ku Kuberikan kepadamu...",
        version: "TB",
        category: "damai",
        notes: ""
    },
    {
        id: 15,
        reference: "Mazmur 37:5",
        verse: "Serahkanlah hidupmu kepada TUHAN dan percayalah kepada-Nya, dan Ia akan bertindak.",
        version: "TB",
        category: "iman",
        notes: ""
    }
];


// ===============================
// SIMPAN AYAT KE LOCALSTORAGE
// ===============================
function saveVerse(date, ref, text, source) {
    const item = { date, ref, text, source };

    let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

    const idx = history.findIndex(x => x.date === date);
    if (idx >= 0) history[idx] = item;
    else history.push(item);

    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
}


// ===============================
// EXPORT KE CSV
// ===============================
function exportCSV() {
    let list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    if (list.length === 0) {
        alert("Data kosong, tidak ada yang dapat diexport.");
        return;
    }

    // Header CSV
    const headers = ["id", "reference", "verse", "version", "category", "notes"];

    // Convert ke CSV format
    const rows = list.map(item => {
        return [
            item.id,
            `"${(item.reference || "").replace(/"/g, '""')}"`,
            `"${(item.verse || "").replace(/"/g, '""')}"`,
            `"${(item.version || "").replace(/"/g, '""')}"`,
            `"${(item.category || "").replace(/"/g, '""')}"`,
            `"${(item.notes || "").replace(/"/g, '""')}"`
        ].join(",");
    });

    const csvContent = [headers.join(","), ...rows].join("\n");

    // Buat file downloadable
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "verses_export.csv";
    document.body.appendChild(a);
    a.click();

    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


document.getElementById("btnExport").onclick = exportCSV;


// ===============================
// FETCH GOOGLE SHEETS CSV
// ===============================
async function loadVerse() {
    const today = new Date().toISOString().slice(0, 10);
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaZfY0xwUB-0cwUAlmyPUJntAyvqiAFCBMQsU_ihJDtjPUrEG7LuAVSa-k_Qdt9V0HKa3Fa8XTNPrA/pub?gid=0&single=true&output=csv";

    console.log("üîç Mencoba load dari Google Sheet...");

    // 1Ô∏è‚É£ --- Coba load dari CSV Google Sheet ---
    try {
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) throw new Error("Fetch CSV failed");

        const text = await response.text();
        const rows = text.split("\n").map(parseCSVLine);

        const row = rows.find(r => r[0] === today);
        if (!row) throw new Error("Row untuk tanggal hari ini tidak ditemukan");

        const reference = row[1]?.trim();
        const verse = row.slice(2).join(",").trim();

        // Cek undefined
        if (!reference || !verse)
            throw new Error("Data CSV tidak lengkap (undefined field)");

        displayVerse(reference, verse);
        console.log("‚úî Berhasil load dari Google Sheet");
        return; // stop, tidak lanjut ke localstorage
    }

    catch (csvErr) {
        console.warn("‚ö† Gagal dari CSV:", csvErr.message);
    }

    // 2Ô∏è‚É£ --- Coba load dari localStorage ---
    importFallbackIfEmpty();

    // 3Ô∏è‚É£ --- Pakai fallback random ---
    console.log("üîç Mencoba load dari fallback local...");

    const fb = fallbackVerses[Math.floor(Math.random() * fallbackVerses.length)];

    if (!fb.reference || !fb.verse) {
        console.error("‚ùå Fallback undefined! Pastikan fallbackVerses benar.");
        displayVerse("Error", "Fallback data corrupt / undefined.");
        return;
    }

    displayVerse(fb.reference, fb.verse);
    console.log("‚úî Menggunakan fallback");
}

function parseCSVLine(line) {
    const result = [];
    let current = "";
    let insideQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const c = line[i];

        if (c === '"' && line[i+1] === '"') {
            current += '"'; // escaped quote ("")
            i++;
        } else if (c === '"') {
            insideQuotes = !insideQuotes;
        } else if (c === ',' && !insideQuotes) {
            result.push(current);
            current = "";
        } else {
            current += c;
        }
    }

    result.push(current);
    return result;
}


// ===============================
// TAMPILKAN AYAT DI WALLPAPER
// ===============================
function displayVerse(refOrObj, textOptional) {

    let reference = "";
    let verse = "";
    let version = "";
    let category = "";
    let notes = "";

    // CASE 1: Masuk dari Google Sheet ‚Üí (ref, text)
    if (typeof refOrObj === "string") {
        reference = refOrObj;
        verse = textOptional || "";
        version = "TB";   // default
    }

    // CASE 2: Masuk dari fallbackVerses atau localStorage ‚Üí object lengkap
    else if (typeof refOrObj === "object") {
        reference = refOrObj.reference;
        verse = refOrObj.verse;
        version = refOrObj.version ?? "TB";
        category = refOrObj.category ?? "";
        notes = refOrObj.notes ?? "";
    }

    // TAMPILKAN DI WALLPAPER
    document.getElementById("ref").textContent = reference;
    document.getElementById("text").textContent = verse;

    // Tambahan OPTIONAL (kalau kamu punya elemen ini di UI)
    const elVersion = document.getElementById("version");
    if (elVersion) elVersion.textContent = version;

    const elCategory = document.getElementById("category");
    if (elCategory) elCategory.textContent = category;

    const elNotes = document.getElementById("notes");
    if (elNotes) elNotes.textContent = notes;
}

loadVerse();

function saveAsImage() {
	const overlay = $("#overlay");
	overlay.css({
	    //zIndex: 99,
	    opacity: 0.499,          // trick
	    transform: "translateZ(0)" // trick
	});
	const cont = $("#container");
	cont.css({
	    zIndex: 999,
	});

	
    const target = document.body; // screenshot seluruh layar wallpaper
	const btn = $(".btn");
	const filename = generateFileName("verse");

	// sembunyikan button agar tidak masuk screenshot
	btn.addClass("hidden");
    html2canvas(target, {
        useCORS: true,
        allowTaint: true,
        scale: 2,            // biar hasilnya HD
        backgroundColor: null
    }).then(canvas => {
        const link = document.createElement("a");
        link.download = filename;
        link.href = canvas.toDataURL("image/png");
        link.click();
        // tampilkan lagi setelah screenshot
        btn.removeClass("hidden");
    });
}

function generateFileName(prefix = "wallpaper") {
    const now = new Date();

    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mi = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');

    return `${prefix}_${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}.png`;
}

document.getElementById("btnDownload").onclick = saveAsImage;


function loadVerses() {
    try {
        let stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return fallbackVerses;

        let verses = JSON.parse(stored);
        if (Array.isArray(verses) && verses.length > 0) return verses;

        return fallbackVerses;
    } catch (e) {
        return fallbackVerses;
    }
}


function addVerseFromFields(ref, verse, version, category, notes) {
    const list = loadVerses();
    const newObj = {
        id: list.length + 1,
        reference: ref,
        verse: verse,
        version: version,
        category: category,
        notes: notes
    };

    list.push(newObj);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
// === BOOTSTRAP MODAL ===
const modalAdd = new bootstrap.Modal(document.getElementById("addVerseModal"));

// OPEN MODAL
$("#btnAdd").on("click", function () {
    modalAdd.show();
});

// SAVE VERSE
$("#btnSaveVerse").on("click", function () {

    const ref     = $("#mRef").val().trim();
    const verse   = $("#mVerse").val().trim();
    const version = $("#mVersion").val().trim();
    const cat     = $("#mCategory").val().trim();
    const notes   = $("#mNotes").val().trim();

    if (!ref || !verse) {
        alert("Reference dan Ayat wajib diisi.");
        return;
    }

    addVerseFromFields(ref, verse, version, cat, notes);

    alert("Ayat berhasil ditambahkan!");
    modalAdd.hide();

    // RESET FORM
    $("#mRef, #mVerse, #mVersion, #mCategory, #mNotes").val("");
});

function loadVersesLS() {
    try {
        let raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];

        let arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];

        return arr;
    } catch (e) {
        console.warn("Failed reading localStorage:", e);
        return [];
    }
}


// Render list ke tabel
let verseTable = null;
function renderVerseList() {
    var list = loadVersesLS();

    // Jika DataTable sudah pernah dibuat ‚Üí destroy dulu
    if (verseTable !== null) {
        verseTable.clear().destroy();
    }

    var tbody = $("#tableVerses tbody");
    tbody.empty();

    if (!list || list.length === 0) {
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted">Belum ada ayat tersimpan.</td>
            </tr>
        `);
    } else {
        list.forEach((item, index) => {

            // Auto-repair jika ada data undefined
            const fixed = {
                id: item.id ?? -1,
                reference: item.reference ?? "[Reference MISSING]",
                verse: item.verse ?? "[Verse MISSING]",
                version: item.version ?? "-",
                category: item.category ?? "-",
                notes: item.notes ?? "-"
            };

            // Jika ada data undefined ‚Üí warning di console
            if (item.reference == null || item.verse == null) {
                console.warn("‚ö† Warning: Data ayat memiliki nilai undefined:", item);
            }

            tbody.append(`
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${fixed.reference}</strong></td>
                    <td>${fixed.verse}</td>
                    <td>${fixed.version}</td>
                    <td>${fixed.category}</td>
                    <td>${fixed.notes}</td>
                </tr>
            `);
        });
    }

    // Aktifkan DataTables
    verseTable = $("#tableVerses").DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        responsive: true,
        order: [[0, "asc"]], 
        language: {
            search: "Cari:",
            lengthMenu: "Tampilkan _MENU_ ayat",
            info: "Menampilkan _START_ - _END_ dari _TOTAL_ ayat",
            paginate: {
                first: "Awal",
                last: "Akhir",
                next: "‚Üí",
                previous: "‚Üê"
            }
        }
    });
}


function importFallbackToLocalStorage() { 

    // Ambil data yang sudah ada
    let list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // Hitung ID terakhir
    let lastId = list.length > 0 ? list[list.length - 1].id : 0;

    // Loop fallbackVerse dan masukkan ke storage
    fallbackVerses.forEach(item => {
        lastId++;

        const newObj = {
            id: lastId,
            reference: item.reference,
            verse: item.verse,
            version: item.version ?? "TB",        // default Terjemahan Baru
            category: item.category ?? "Umum",    // default kategori
            notes: item.notes ?? ""               // default kosong
        };

        list.push(newObj);
    });

    // Simpan kembali ke localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

    console.log("Fallback verses imported:", fallbackVerses.length);
}
function importFallbackIfEmpty() { 
    let list = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    if (list.length > 0) {
        console.log("LocalStorage already has data. Skip import.");
        return;
    }

    importFallbackToLocalStorage();
}

function clearLocalStorage() {
    localStorage.removeItem(STORAGE_KEY);
}


</script>
</html>





